import { useState, useEffect } from 'react';
import { activeScanApi } from '../api/scanApi';

type ScanMode = 'safe' | 'normal' | 'aggressive';

export default function UnifiedScan() {
  const [domain, setDomain] = useState('');
  const [scanMode, setScanMode] = useState<ScanMode>('safe');
  const [isScanning, setIsScanning] = useState(false);
  const [scanId, setScanId] = useState<number | null>(null);
  const [scanData, setScanData] = useState<any>(null);
  const [logs, setLogs] = useState<string[]>([]);
  const [findings, setFindings] = useState<any[]>([]);

  // Poll for scan updates
  useEffect(() => {
    if (scanId && isScanning) {
      const interval = setInterval(async () => {
        try {
          const result = await activeScanApi.getScan(scanId);
          setScanData(result.data);
          
          if (result.data.findings) {
            const newFindings = result.data.findings;
            if (newFindings.length > findings.length) {
              const justAdded = newFindings.slice(findings.length);
              justAdded.forEach((f: any) => {
                addLog(`üî¥ [${f.severity}] ${f.category}: ${f.finding}`);
              });
            }
            setFindings(newFindings);
          }

          if (result.data.status === 'completed') {
            addLog(`‚úÖ Scan completed! Total findings: ${result.data.findings?.length || 0}`);
            addLog(`üìä Risk Score: ${result.data.risk_score}/100 (${result.data.risk_grade})`);
            setIsScanning(false);
            clearInterval(interval);
          } else if (result.data.status === 'failed') {
            addLog(`‚ùå Scan failed`);
            setIsScanning(false);
            clearInterval(interval);
          }
        } catch (error) {
          console.error('Error polling scan:', error);
        }
      }, 3000);

      return () => clearInterval(interval);
    }
  }, [scanId, isScanning, findings.length]);

  const addLog = (message: string) => {
    const timestamp = new Date().toLocaleTimeString();
    setLogs(prev => [...prev, `[${timestamp}] ${message}`]);
  };

  const startScan = async () => {
    if (!domain) {
      alert('Please enter a domain!');
      return;
    }

    setIsScanning(true);
    setLogs([]);
    setFindings([]);
    setScanData(null);
    setScanId(null);

    addLog(`üåô NIGHTFALL TSUKUYOMI - Initializing scan`);
    addLog(`üéØ Target: ${domain}`);
    addLog(`üîß Mode: ${scanMode.toUpperCase()}`);
    addLog(`---`);

    try {
      addLog(`üì° Creating target in database...`);
      const result = await activeScanApi.createScan({ domain, mode: scanMode });
      
      if (result.data && result.data.id) {
        setScanId(result.data.id);
        addLog(`‚úÖ Scan #${result.data.id} created successfully`);
        addLog(`üîç Starting active security scan...`);
        addLog(`‚è≥ Phase 1: Core Security Checks (20 modules)`);
        addLog(`‚è≥ This may take 2-5 minutes...`);
        addLog(`---`);
      } else {
        addLog(`‚ùå Failed to create scan`);
        setIsScanning(false);
      }
    } catch (error: any) {
      addLog(`‚ùå Error: ${error.message}`);
      console.error('Scan error:', error);
      setIsScanning(false);
    }
  };

  const getSeverityColor = (severity: string) => {
    const colors: Record<string, string> = {
      Critical: 'bg-red-500',
      High: 'bg-orange-500',
      Medium: 'bg-yellow-500',
      Low: 'bg-green-500',
      Info: 'bg-blue-500',
    };
    return colors[severity] || 'bg-gray-500';
  };

  return (
    <div className="container mx-auto p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold bg-gradient-to-r from-purple-400 to-cyan-400 bg-clip-text text-transparent">
            üåô Nightfall Tsukuyomi
          </h1>
          <p className="text-gray-400 mt-1">Advanced Security Intelligence Platform</p>
        </div>
      </div>

      {/* Scan Controls */}
      <div className="border border-purple-500/20 bg-gradient-to-br from-gray-900 to-gray-800 rounded-lg p-6 space-y-4">
        <h2 className="text-xl font-bold">Execute Security Scan</h2>
        
        <div className="space-y-2">
          <label className="text-sm font-medium">Target Domain</label>
          <input
            type="text"
            placeholder="example.com"
            value={domain}
            onChange={(e) => setDomain(e.target.value)}
            className="w-full bg-gray-800 border border-gray-700 rounded px-4 py-3 text-white text-lg"
            disabled={isScanning}
          />
        </div>

        <div className="space-y-2">
          <label className="text-sm font-medium">Scan Mode</label>
          <div className="grid grid-cols-3 gap-2">
            {(['safe', 'normal', 'aggressive'] as const).map((mode) => (
              <button
                key={mode}
                onClick={() => setScanMode(mode)}
                disabled={isScanning}
                className={`px-4 py-3 rounded text-sm transition-colors ${
                  scanMode === mode 
                    ? 'bg-purple-500 text-white' 
                    : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                }`}
              >
                {mode.charAt(0).toUpperCase() + mode.slice(1)}
              </button>
            ))}
          </div>
        </div>

        <button
          onClick={startScan}
          disabled={isScanning || !domain}
          className="w-full bg-gradient-to-r from-purple-500 to-cyan-500 hover:from-purple-600 hover:to-cyan-600 px-4 py-4 rounded font-bold text-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all"
        >
          {isScanning ? '‚è≥ Scanning...' : '‚ñ∂Ô∏è Execute Scan'}
        </button>
      </div>

      {/* Live Console */}
      {logs.length > 0 && (
        <div className="border border-cyan-500/50 bg-black/90 rounded-lg p-6">
          <div className="flex items-center gap-3 mb-4">
            <div className="w-3 h-3 bg-cyan-400 rounded-full animate-pulse"></div>
            <h2 className="text-lg font-bold text-cyan-400">LIVE CONSOLE OUTPUT</h2>
          </div>
          
          <div className="bg-black rounded-lg p-4 font-mono text-sm max-h-80 overflow-y-auto space-y-1">
            {logs.map((log, idx) => (
              <div key={idx} className="text-green-400">
                {log}
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Status Cards */}
      {scanData && (
        <div className="grid grid-cols-3 gap-4">
          <div className="bg-gray-800 border border-purple-500/20 rounded-lg p-4">
            <p className="text-sm text-gray-400">Status</p>
            <p className={`text-2xl font-bold ${
              scanData.status === 'completed' ? 'text-green-400' :
              scanData.status === 'running' ? 'text-blue-400' : 'text-yellow-400'
            }`}>
              {scanData.status.toUpperCase()}
            </p>
          </div>

          <div className="bg-gray-800 border border-purple-500/20 rounded-lg p-4">
            <p className="text-sm text-gray-400">Risk Score</p>
            <p className="text-2xl font-bold text-purple-400">
              {scanData.risk_score}/100
            </p>
            {scanData.risk_grade && (
              <span className={`inline-block mt-2 px-3 py-1 rounded text-sm ${
                scanData.risk_grade === 'HIGH' ? 'bg-red-500' :
                scanData.risk_grade === 'MEDIUM' ? 'bg-yellow-500' : 'bg-green-500'
              }`}>
                {scanData.risk_grade}
              </span>
            )}
          </div>

          <div className="bg-gray-800 border border-purple-500/20 rounded-lg p-4">
            <p className="text-sm text-gray-400">Total Findings</p>
            <p className="text-2xl font-bold text-cyan-400">{findings.length}</p>
          </div>
        </div>
      )}

      {/* Findings List */}
      {findings.length > 0 && (
        <div className="bg-gray-800 border border-purple-500/20 rounded-lg p-6">
          <h3 className="text-lg font-bold mb-4 text-purple-400">
            üõ°Ô∏è Vulnerability Findings ({findings.length})
          </h3>
          <div className="space-y-3 max-h-[600px] overflow-y-auto">
            {findings.map((finding: any, idx: number) => (
              <div key={idx} className="p-4 bg-gray-900 rounded border border-gray-700 hover:border-purple-500 transition-colors">
                <div className="flex items-start justify-between mb-2">
                  <div className="flex items-center gap-2">
                    <span className={`px-2 py-1 rounded text-xs font-bold text-white ${getSeverityColor(finding.severity)}`}>
                      {finding.severity}
                    </span>
                    <span className="px-2 py-1 rounded text-xs border border-gray-600 text-gray-300">{finding.category}</span>
                    <span className="px-2 py-1 rounded text-xs border border-gray-600 text-gray-400">{finding.confidence}</span>
                  </div>
                  <span className="text-xs text-gray-500">{finding.http_method} ‚Üí {finding.outcome}</span>
                </div>
                <p className="font-medium mb-2 text-white">{finding.finding}</p>
                <p className="text-sm text-gray-400">{finding.remediation}</p>
                {finding.evidence && (
                  <details className="mt-2">
                    <summary className="text-xs text-gray-500 cursor-pointer hover:text-gray-300">Show Evidence</summary>
                    <pre className="mt-2 p-2 bg-gray-950 rounded text-xs overflow-x-auto text-gray-300">{finding.evidence}</pre>
                  </details>
                )}
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
}
